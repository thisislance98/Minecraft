<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://apis.google.com https://www.gstatic.com https://www.googletagmanager.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: blob: https:;
        connect-src 'self' ws: wss: http://localhost:* https://generativelanguage.googleapis.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://*.googleapis.com https://cdn.jsdelivr.net https://www.google-analytics.com;
        media-src 'self' blob:;
        worker-src 'self' blob:;
        frame-src https://accounts.google.com;
    ">
    <title>Voxel World - Minecraft Clone</title>
    <link rel="stylesheet" href="/src/styles/index.css">
    <link rel="icon" href="/favicon.ico" />
</head>

<body>
    <div id="game-container" tabindex="0"></div>

    <div id="crosshair"></div>
    <div id="creature-tooltip"></div>

    <!-- Damage overlay for visual feedback -->
    <div id="damage-overlay"></div>

    <!-- Visual Improvements: Vignette -->
    <div id="vignette-overlay"></div>

    <!-- HMR Update Notifications -->
    <div id="hmr-notifications"></div>

    <!-- In-Game Notifications (errors, warnings, etc) -->
    <div id="game-notifications"></div>

    <!-- Mobile Orientation Warning -->
    <div id="landscape-warning" class="hidden">
        <div class="warning-content">
            <div class="rotate-icon">‚ü≥</div>
            <h2>Please Rotate Device</h2>
            <p>This experience is best viewed in landscape mode.</p>
        </div>
    </div>

    <!-- Status Bars Container -->
    <div id="status-bars">
        <div id="health-bar">
            <div id="health-hearts"></div>
        </div>
    </div>

    <div id="hud">
        <div id="hotbar">
            <!-- Dynamically generated -->
        </div>
    </div>

    <div id="inventory-screen" class="hidden">
        <div class="inventory-container">
            <div id="crafting-area">
                <div class="inventory-label">Crafting</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="crafting-grid">
                        <!-- Dynamically generated 9 slots -->
                    </div>
                    <div class="crafting-arrow">‚ûú</div>
                    <div class="crafting-result-container">
                        <div class="crafting-result"></div>
                    </div>
                </div>
            </div>

            <div class="inventory-label">Inventory</div>
            <div id="main-inventory-grid" class="inventory-grid">
                <!-- Dynamically generated 27 slots -->
            </div>

            <div class="inventory-label">Hotbar</div>
            <div id="hotbar-inventory-grid" class="inventory-grid">
                <!-- Dynamically generated 9 slots -->
            </div>
        </div>
    </div>

    <div id="drag-icon" class="hidden"></div>

    <div id="fps-counter">FPS: <span id="fps">0</span></div>

    <button id="auth-btn">üë§ Sign In</button>

    <!-- Auth Modal (Sign In / Sign Up) -->
    <div id="auth-modal" class="hidden">
        <div class="auth-modal-content">
            <div class="auth-header">
                <h3>üë§ Account</h3>
                <button id="auth-close">√ó</button>
            </div>
            <div class="auth-body">
                <div id="auth-content-placeholder">
                    <!-- Content populated by StoreUI.js -->
                </div>
            </div>
        </div>
    </div>

    <div id="top-right-controls">
        <button id="spawn-btn" title="Spawn Menu">‚ö°</button>
        <button id="voice-btn" title="Toggle Voice Chat">üé§</button>
        <button id="help-btn">‚ùì</button>
        <button id="settings-btn">‚öôÔ∏è</button>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden">
        <div class="settings-modal-content">
            <div class="settings-header">
                <h3>‚öôÔ∏è Settings</h3>
                <button id="settings-close">√ó</button>
            </div>
            <div class="settings-body">
                <!-- Audio Settings -->
                <div class="settings-section">
                    <h4>üîä Audio</h4>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-audio-toggle" checked>
                        <span>Sound Effects</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-voice-toggle">
                        <span>Voice Chat</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-thoughts-toggle">
                        <span>Merlin Thoughts (Show AI reasoning)</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-bypass-tokens-toggle" checked>
                        <span>Bypass Token Requirements (Free Mode)</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-ai-provider-toggle">
                        <span>üßô Use Claude Code (instead of Gemini)</span>
                    </label>
                    <p class="settings-description" style="margin: 4px 0 0 26px; font-size: 0.9em; opacity: 0.7;">When
                        enabled, Merlin uses Claude Code with custom skills. Interact via the Claude Code terminal.</p>
                </div>

                <!-- Graphics Quality Presets -->
                <div class="settings-section">
                    <h4>üéÆ Graphics</h4>
                    <p class="settings-description" style="margin-bottom: 12px;">Choose a preset for your hardware or
                        customize below.</p>
                    <div class="graphics-presets" style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button id="preset-fast" class="preset-btn" title="Best performance for older computers">‚ö°
                            Fast</button>
                        <button id="preset-balanced" class="preset-btn"
                            title="Good balance of quality and performance">‚öñÔ∏è Balanced</button>
                        <button id="preset-beautiful" class="preset-btn"
                            title="Maximum quality (requires good hardware)">‚ú® Beautiful</button>
                    </div>
                    <div class="settings-slider">
                        <label for="settings-render-distance"
                            style="display: flex; justify-content: space-between; align-items: center;">
                            <span>üåç Render Distance</span>
                            <span id="render-distance-value">6</span>
                        </label>
                        <input type="range" id="settings-render-distance" min="2" max="12" step="1" value="6"
                            style="width: 100%;">
                    </div>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-shadows-toggle" checked>
                        <span>Shadows</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-particles-toggle" checked>
                        <span>Particles</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-grass-toggle" checked>
                        <span>Grass Details</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-weather-toggle" checked>
                        <span>Weather Effects</span>
                    </label>
                </div>

                <!-- Startup Settings -->
                <div class="settings-section">
                    <h4>üöÄ Startup</h4>
                    <p class="settings-description">Control what shows when the game starts.</p>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-show-name-prompt-toggle">
                        <span>Show Name Prompt</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-show-help-toggle">
                        <span>Show Help on First Visit</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-show-announcements-toggle">
                        <span>Show Announcements</span>
                    </label>
                </div>

                <!-- Display Settings -->
                <div class="settings-section">
                    <h4>üìä Display</h4>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-fps-toggle" checked>
                        <span>FPS Counter</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-position-toggle" checked>
                        <span>Position Display</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-minimap-toggle" checked>
                        <span>Show Minimap</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-mobile-toggle">
                        <span>Mobile Controls</span>
                    </label>
                    <div class="settings-slider" style="margin-top: 12px;">
                        <label for="settings-jump-slider"
                            style="display: flex; justify-content: space-between; align-items: center;">
                            <span>ü¶ò Jump Height</span>
                            <span id="jump-value">0.15</span>
                        </label>
                        <input type="range" id="settings-jump-slider" min="0.05" max="0.30" step="0.01" value="0.15"
                            style="width: 100%;">
                    </div>
                    <button id="settings-fullscreen-btn" class="spawn-btn full-width hidden" style="margin-top: 10px;">‚õ∂
                        Go Fullscreen</button>
                </div>

                <!-- Hotkey Settings -->
                <div class="settings-section">
                    <h4>‚å®Ô∏è Hotkeys</h4>
                    <p class="settings-description">Click a key box and press a key to reassign.</p>
                    <label class="settings-hotkey">
                        <span>Use Item / Interact</span>
                        <input type="text" id="settings-hotkey-secondary" class="hotkey-input" readonly value="E">
                    </label>
                </div>




                <!-- World Settings -->
                <div class="settings-section">
                    <h4>üåç World</h4>
                    <label class="settings-toggle">
                        <input type="checkbox" id="settings-persistence-toggle">
                        <span>Creature Persistence (Save/Load Animals)</span>
                    </label>
                    <p class="settings-description">Reset the world to regenerate terrain and clear all placed blocks,
                        creatures, and signs.</p>
                    <div style="display: flex; gap: 10px;">
                        <!-- <button id="settings-help-btn" class="spawn-btn" style="flex: 1;">‚ùì Help / Controls</button> REMOVED -->
                        <button id="reset-world-btn" class="danger-btn" style="flex: 1; width: 100%;">üóëÔ∏è Reset
                            World</button>
                    </div>
                </div>

                <!-- Player Appearance Settings -->
                <div class="settings-section">
                    <h4>üë§ Appearance</h4>
                    <p class="settings-description">Choose your shirt color.</p>
                    <div id="settings-shirt-color-picker" class="color-picker-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- World Warp Settings -->
                <div class="settings-section">
                    <h4>üöÄ World Warp</h4>
                    <p class="settings-description">Instantly travel to another world.</p>
                    <div class="warp-buttons-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button id="settings-warp-earth" class="warp-btn warp-earth">
                            üåç Earth<br><small>Home World</small>
                        </button>
                        <button id="settings-warp-crystal" class="warp-btn warp-crystal">
                            üíé Crystal<br><small>Purple Crystals</small>
                        </button>
                        <button id="settings-warp-lava" class="warp-btn warp-lava">
                            üåã Lava<br><small>Volcanic Terrain</small>
                        </button>
                        <button id="settings-warp-moon" class="warp-btn warp-moon">
                            üåô Moon<br><small>Lunar Surface</small>
                        </button>
                        <button id="settings-warp-soccer" class="warp-btn warp-soccer" style="grid-column: span 2;">
                            ‚öΩ Soccer<br><small>Rocket League Arena</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help / Tutorial Modal -->
    <div id="help-modal" class="hidden">
        <div class="help-modal-content">
            <div class="help-header">
                <h3>‚ùì How to Play</h3>
                <button id="help-close">√ó</button>
            </div>
            <div class="help-body">
                <div class="help-section">
                    <h4>‚å®Ô∏è Controls</h4>
                    <div class="control-grid">
                        <div class="control-item"><span class="key">W</span><span class="key">A</span><span
                                class="key">S</span><span class="key">D</span> <span>Move</span></div>
                        <div class="control-item"><span class="key">Space</span> <span>Jump</span></div>
                        <div class="control-item"><span class="key">Shift</span> <span>Sprint</span></div>
                        <div class="control-item"><span class="key">Ctrl</span> <span>Sneak / Fly Down</span></div>
                        <div class="control-item"><span class="key">Q</span> <span>Drop Item</span></div>

                        <div class="control-item"><span class="key">E</span> <span>Inventory / Interact</span></div>
                        <div class="control-item"><span class="key mouse">L-Click</span> <span>Mine / Attack</span>
                        </div>
                        <div class="control-item"><span class="key mouse">R-Click</span> / <span class="key">E</span>
                            <span>Place / Use</span>
                        </div>
                        <div class="control-item"><span class="key">1</span>-<span class="key">9</span> <span>Select
                                Item</span></div>
                        <div class="control-item"><span class="key">R</span> <span>Spawn Menu</span></div>
                        <div class="control-item"><span class="key">P</span> <span>Debug Panel</span></div>
                    </div>
                </div>

                <div class="help-section">
                    <h4>üé§ Voice Chat</h4>
                    <p>Talk to other players with spatial voice chat!</p>
                    <div class="control-grid">
                        <div class="control-item"><span class="key">V</span> <span>Push-to-Talk</span></div>
                        <div class="control-item"><span class="key">üé§</span> <span>Toggle Voice On/Off</span></div>
                    </div>
                    <p style="margin-top: 8px; font-size: 0.9em; opacity: 0.8;">Click the üé§ button or use Settings to
                        enable voice. Hold V to transmit.</p>
                </div>

                <div class="help-section">
                    <h4>ü§ñ AI Assistant</h4>
                    <p>Press <span class="key">T</span> or click the Chat icon to talk to the AI.</p>
                    <ul>
                        <li><strong>Chat:</strong> Ask questions or just talk!</li>
                        <li><strong>Creation:</strong> Ask the AI to "make a gold sword" or "spawn a sheep".</li>
                        <li><strong>Ideas:</strong> Click üí° in chat to get inspiration.</li>
                    </ul>
                </div>

                <div class="help-footer">
                    <button id="help-ok-btn" class="spawn-btn full-width">Got it! Let's Play</button>
                </div>
            </div>
        </div>
    </div>

    <div id="debug">
        <button class="debug-close-btn" onclick="this.parentElement.classList.add('hidden')" title="Close">√ó</button>
        <p><span id="version-text">v1.0.1244</span><span id="version-badge" class="hidden">NEW</span></p>
        <p>Position: <span id="position">0, 0, 0</span></p>
        <p>Blocks: <span id="block-count">0</span></p>
    </div>

    <!-- Toggleable Debug Panel for Performance Isolation -->
    <div id="debug-panel" class="hidden">
        <h3>Debug Settings</h3>
        <label><input type="checkbox" id="dbg-animals" checked> Update Animals</label>
        <label><input type="checkbox" id="dbg-chunks" checked> Update Chunks</label>
        <label><input type="checkbox" id="dbg-env" checked> Day/Night Cycle</label>
        <label><input type="checkbox" id="dbg-particles" checked> Particles (Fire/etc)</label>
        <p class="hint">Press 'P' to toggle panel</p>
    </div>

    <div id="block-indicator">
        Selected: <span id="selected-block">Grass</span>
    </div>

    <!-- AI Chat Side Panel -->
    <div id="spawn-panel" class="hidden">
        <div class="chat-header">
            <div class="chat-title">SPAWN MENU</div>
            <button id="close-spawn">√ó</button>
        </div>
        <div class="spawn-search-container">
            <input type="text" id="spawn-search" placeholder="Search..." autocomplete="off">
        </div>
        <div id="spawn-grid">
            <!-- Dynamically generated buttons -->
        </div>
    </div>

    <div id="chat-panel" class="hidden">
        <div class="chat-header">
            <div class="chat-title">CHAT</div>
            <button id="clear-chat" title="Clear Chat History"
                style="background: none; border: none; font-size: 20px; cursor: pointer; color: #fff; margin-right: 10px;">üóëÔ∏è</button>
            <button id="copy-chat" title="Copy Conversation"
                style="background: none; border: none; font-size: 20px; cursor: pointer; color: #fff; margin-right: 10px;">üìã</button>
            <button id="close-chat">√ó</button>
        </div>
        <div class="chat-tabs">
            <button class="chat-tab active" data-mode="ai"><span class="tab-icon">üßô</span>Merlin</button>
            <button class="chat-tab" data-mode="group"><span class="tab-icon">üë•</span>Group</button>
            <button class="chat-tab" data-mode="player"><span class="tab-icon">üí¨</span>Player</button>
        </div>
        <div id="chat-messages-ai" class="chat-messages-container active">
            <!-- AI Messages -->
            <div class="message ai">
                <div class="message-content">Greetings, traveler. I am the Wizard of Code. How may I assist you in
                    shaping this world?</div>
            </div>
        </div>
        <div id="chat-messages-group" class="chat-messages-container">
            <!-- Group Messages -->
        </div>
        <div id="chat-messages-player" class="chat-messages-container">
            <!-- Player Chat Messages -->
        </div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off">
            <button id="idea-btn" title="Get an Idea"
                style="background: none; border: none; font-size: 20px; cursor: pointer; margin-right: 5px;">üí°</button>
            <button id="send-chat">Send</button>
        </div>
    </div>



    <script type="module">
        import { MerlinClient } from '/src/game/ai/MerlinClient.js';
        // Initialize AI Client immediately, independent of Game logic
        window.merlinClient = new MerlinClient();
    </script>
    <script type="module" src="/src/main.js"></script>
</body>

</html>